<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poetsen+One&display=swap"
      rel="stylesheet"
    />
    <style>
      html {
        font-family: "Poetsen One", sans-serif;
        font-weight: 400;
      }
      body {
        margin: 0;
      }
      p {
        margin: 0;
      }
      .city-container {
        padding: 12px;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        background-color: beige;
      }
      .page-container {
        margin: auto;
        width: 1120px;
      }
    </style>
    <script>
      (async () => {
        const regions = [
          {
            label: "Winnipeg DC",
            id: "dc49",
            cities: [
              {
                label: "Winnipeg",
                url: "https://weatherapi.pelmorex.com/api/v1/longterm?locale=en-CA&lat=49.854&long=-97.175&unit=metric&count=15&offset=0",
              },
              {
                label: "Brandon",
                url: "https://weatherapi.pelmorex.com/api/v1/longterm?locale=en-CA&lat=49.85&long=-99.96&unit=metric&count=15&offset=0",
              },
              {
                label: "Morden",
                url: "https://weatherapi.pelmorex.com/api/v1/longterm?locale=en-CA&lat=49.192&long=-98.112&unit=metric&count=15&offset=0",
              },
              {
                label: "Thompson",
                url: "https://weatherapi.pelmorex.com/api/v1/longterm?locale=en-CA&lat=55.76&long=-97.842&unit=metric&count=15&offset=0",
              },
              {
                label: "Regina",
                url: "https://weatherapi.pelmorex.com/api/v1/longterm?locale=en-CA&lat=50.455&long=-104.618&unit=metric&count=15&offset=0",
              },
              {
                label: "Kenora",
                url: "https://weatherapi.pelmorex.com/api/v1/longterm?locale=en-CA&lat=49.779&long=-94.467&unit=metric&count=15&offset=0",
              },
              {
                label: "Thunder Bay",
                url: "https://weatherapi.pelmorex.com/api/v1/longterm?locale=en-CA&lat=48.402&long=-89.31&unit=metric&count=15&offset=0",
              },
            ],
          },
          {
            label: "Vancouver DC",
            id: "dc26",
            cities: [
              {
                label: "Prince George",
                url: "https://weatherapi.pelmorex.com/api/v1/longterm?locale=en-CA&lat=53.927&long=-122.765&unit=metric&count=15&offset=0",
              },
              {
                label: "Smithers",
                url: "https://weatherapi.pelmorex.com/api/v1/longterm?locale=en-CA&lat=54.791&long=-127.178&unit=metric&count=15&offset=0",
              },
            ],
          },
        ];
        const regionsAPIData = await Promise.all(
          regions.map(async (region) => {
            const citiesAPIData = await Promise.all(
              region.cities.map(async (city) => {
                const res = await fetch(city.url);
                const rawData = await res.json();
                const cityData = {
                  date: new Date(
                    rawData.longTerm[2].time.local
                  ).toLocaleDateString(),
                  temperature: rawData.longTerm[2].day.temperature.value,
                  snow: rawData.longTerm[2].snow.value,
                  wind: rawData.longTerm[2].day.wind.speed,
                  rain: rawData.longTerm[2].rain.value,
                };
                const cityUnits = {
                  snow: rawData.display.unit.snow,
                  wind: rawData.display.unit.wind,
                  temperature: rawData.display.unit.temperature,
                };
                return {
                  label: city.label,
                  data: cityData,
                  units: cityUnits,
                };
              })
            );

            return {
              ...region,
              cities: citiesAPIData,
            };
          })
        );

        console.log(regionsAPIData);

        const regionsData = regionsAPIData.map((region) => {
          const citiesData = region.cities
            .map((city) => {
              const windAlert = city.data.wind > 18;
              const snowAlert = city.data.snow > 0;
              const rainAlert = city.data.rain > 0;

              const generalAlert = windAlert || snowAlert || rainAlert;

              return {
                ...city,
                alert: {
                  wind: windAlert,
                  snow: snowAlert,
                  rain: rainAlert,
                  general: generalAlert,
                },
              };
            })
            .sort((a, b) => (a.alert.general ? -1 : 1));

          return {
            ...region,
            cities: citiesData,
          };
        });

        console.log(regionsData);

        regionsData.forEach((region) => {
          const pageContainer = document.querySelector("#page-container");

          const regionContainer = document.createElement("div");
          pageContainer.appendChild(regionContainer);
          regionContainer.id = `region-${region.id}`;
          const regionHeader = document.createElement("h2");
          regionContainer.appendChild(regionHeader);
          regionHeader.innerText = region.label;

          const citiesContainer = document.createElement("div");
          regionContainer.appendChild(citiesContainer);
          citiesContainer.id = "halfway";
          citiesContainer.style.display = "flex";
          citiesContainer.style.gap = "16px";

          region.cities
            //.filter((city) => city.snow > 0 || city.wind > 0)
            .forEach((city) => {
              const cityContainer = document.createElement("div");
              cityContainer.id = `city-${city.label}`;
              cityContainer.className = "city-container";
              citiesContainer.appendChild(cityContainer);

              if (city.alert.general) {
                cityContainer.style.outline = "2px solid crimson";
              }

              const cityLabel = document.createElement("p");
              cityLabel.innerText = `City: ${city.label}`;
              cityContainer.appendChild(cityLabel);

              const cityDate = document.createElement("p");
              cityDate.innerText = `Date: ${city.data.date}`;
              cityContainer.appendChild(cityDate);

              const cityTemperature = document.createElement("p");
              cityTemperature.innerText = `Temperature: ${city.data.temperature}`;
              cityContainer.appendChild(cityTemperature);

              const citySnow = document.createElement("p");
              citySnow.innerText = `Snow: ${city.data.snow}`;
              cityContainer.appendChild(citySnow);
              if (city.alert.snow) {
                citySnow.style.color = "red";
              }

              const cityWind = document.createElement("p");
              cityWind.innerText = `Wind: ${city.data.wind}`;
              cityContainer.appendChild(cityWind);
              if (city.alert.wind) {
                cityWind.style.color = "red";
              }

              const cityRain = document.createElement("p");
              cityRain.innerText = `Rain: ${city.data.rain}`;
              cityContainer.appendChild(cityRain);
              if (city.alert.rain) {
                cityRain.style.color = "red";
              }
            });
        });
      })();
    </script>
  </head>
  <body>
    <div class="page-container" id="page-container"></div>
  </body>
</html>
